<!doctype html>
<html>

<head>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-style: Helvetica, Arial;
      font-size: 0;
    }

    table {
      width: 100vw;
      text-align: center;
      border: none;
      border-collapse: collapse;
    }

    tr {
      height: 29px;
    }

    td {
      text-align: center;
      font-size: 25px;
      max-width: 25vw;
    }

    input,
    select {
      text-align: center;
      text-align-last: center;
      font-size: 25px;
    }


    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button {
      -webkit-appearance: none;
    }

    .iconRight {
      text-align: right;
    }

    .iconRight img {
      margin-left: 5px;
    }

    .modalcontainer {
      position: fixed;
    }

    .modal {
      display: none;
    }

    .modal.show {
      display: block;
      position: absolute;
      background-color: #fff;
      margin: auto;
      padding: 2em;
      width: 80vw;

      /* Fallback for browsers that do not support Custom Properties */
      height: calc(100vh - 60px);

      height: calc(var(--vh, 1vh) * 100 - 60px);
      top: 30px;
      left: 10vw;
      border: 1px solid black;
      overflow: auto;
    }

    .modal td {
      font-size: 15px;
    }

    .modal table {
      width: 78vw;
    }

    .modal table td {
      padding: 5px;

    }

    .header {
      background-color: yellow;
    }

    .result {
      background-color: #98FB98;
    }

    .buttons {
      color: red;
      font-weight: bolder;

      position: fixed;
      right: 0;
      top: 30px;
      font-size: 30px;
    }

    .logButtons {
      position: fixed;
      margin-top: -15px;
      text-align: right;
      right: 0;
    }

    .logo {
      position: fixed;
      left: 0;
      top: 30px;
    }

    .table {
      color: black;
      background-color: cyan;
    }

    .table.notfound {
      background-color: red;
    }

    .output.off {
      background-color: #3fd35d;
    }

    .output.on {
      background-color: red;
    }

    .output.execute {
      background-color: #FFC000;
    }

    .output.forcedOn {
      background-color: #CC66FF;
    }

    .output.forcedOff {
      background-color: #EEBBEE;
    }

    .input.off {
      background-color: #CCFFCC;
    }

    .input.on {
      background-color: yellow;
    }

    .input.forcedOn {
      background-color: #CC66FF;
    }

    .input.forcedOff {
      background-color: #EEBBEE;
    }

    .selfLearning.inProgress {
      background-color: yellow;
    }

    .selfLearning.done {
      background-color: #3fd35d;
    }

    .selfLearning.warning {
      background-color: #FFC000;
    }
  </style>
</head>

<body>
  <div class='modalcontainer'>
    <div id='logModal' class='modal'>

    </div>
  </div>
  <table id="content">
  </table>
  <div class="buttons">
    <img id="uploadButton" src="/res/upload.png" height="30" width="30" onclick="javascript:goFileUpload()">

    <img src="/res/settings.svg" height="30" width="30" onclick="javascript:goSettings()">

    <img src="/res/restart.ico" height="30" width="30" onclick="javascript:goRestart()">

    <img id="shutDownButton" src="/res/shutdown.ico" height="30" width="30" onclick="javascript:goShutdown()">
  </div>
  <div class="logo">
    <img id="logo" src="/res/defaultLogo.jpg">
  </div>
  <script src="/socket.io/socket.io.js"></script>
  <script src="/res/jquery-1.11.1.js"></script>
  <script src="/current.js"></script>
  <script src="/config.static.js"></script>
  <script>
    // Hack to get proper vh unit on tablet
    let vh = window.innerHeight * 0.01;
    document.documentElement.style.setProperty('--vh', vh + 'px');
    // end hack

    document.title = constants.name;
    var socket = io();
    const numColumns = 5;
    var numRows = 0;

    const numTable = config.table.cells.length;

    const numOutputs = config.output.ports.length;
    const numInputs = config.input.ports.length;

    function address(columnNum, rowNum) {
      while (rowNum >= numRows) {
        var currentRow = $('<tr>');
        $('#content').append(currentRow);
        for (let i = 0; i < numColumns; i++) {
          currentRow.append($('<td>').attr('id', 'c' + i + 'r' + numRows));
        }
        numRows++;
      }
      return '#c' + columnNum + 'r' + rowNum;
    }

    function shiftEntries(index) {
      var numEntries = config.serial.coms[index].entries

      for (var i = numEntries; i > 0; i--) {
        $('.com' + index + 'time' + i).html($('.com' + index + 'time' + (i - 1)).html());
        $('.com' + index + 'entry' + i).html($('.com' + index + 'entry' + (i - 1)).html());
      }
    }

    function goSettings() {
      if (confirm("Do you want to go to the settings?")) {
        window.location.href = '/settings';
      }
    }

    function goShutdown() {
      if (confirm("Do you really want to shut down?")) {
        window.location.href = '/shutdown';
      }
    }

    function goRestart() {
      if (confirm("Do you really want to restart?")) {
        window.location.href = '/restart';
      }
    }

    function goFileUpload() {
      if (confirm("Do you really want to upload a file?")) {
        window.location.href = '/fileupload';
      }
    }

    function clickOutput(index) {
      socket.emit('forceOutput', index);
    }

    function clickInput(index) {
      socket.emit('forceInput', index);
    }

    function printDate(time) {
      var date = new Date(time);
      return date.getDate() + '-' + (date.getMonth() + 1) + '-' + (date.getYear() + 1900);
    }

    function printTime(time) {
      var date = new Date(time);
      return date.getHours() + ':' + ("0" + date.getMinutes()).slice(-2) + ':' + ("0" + date.getSeconds()).slice(-2);
    }

    function manualIncrement(index) {
      let newVal;
      if (config.table.cells[index].formula === '#') {
        newVal = Number($('#manual' + index).val()) + 1
      } else {
        const selectedOption = $('#manual' + index + ' option:selected');
        if (selectedOption.next().length) {
          newVal = selectedOption.next().val();
        }
        else {
          newVal = selectedOption.parent().children().first().val();
        }
      }

      $('#manual' + index).val(newVal);
      manualChange(index);
    }

    function manualDecrement(index) {
      let newVal;
      if (config.table.cells[index].formula === '#') {
        newVal = Number($('#manual' + index).val()) - 1
      } else {
        const selectedOption = $('#manual' + index + ' option:selected');
        if (selectedOption.prev().length) {
          newVal = selectedOption.prev().val();
        }
        else {
          newVal = selectedOption.parent().children().last().val();
        }
      }

      $('#manual' + index).val(newVal);
      manualChange(index);
    }

    function manualChange(index) {
      socket.emit('manual', { index: index, value: $('#manual' + index).val() })
    }

    function logTable(legend, entries) {
      legend = legend.slice(2);
      entries = entries.map(entry => entry.slice(2));
      const legendRow = '<tr>' + legend.reduce((total, cur) => total + '<td><b>' + cur + '</b></td>', '') + '</tr>';
      const entryRows = entries.map(row => '<tr>' + row.reduce((total, cur) => total + '<td>' + cur + '</td>', '') + '</tr>');

      return '<table>' + legendRow + entryRows.reduce((total, cur) => total + cur, '') + '</table>';
    }

    function individualData(data){
      const legend = ['Cal', 'Key', 'Tol', '<input size="3" type="text">', '<button>Del</button>']
      const legendRow = '<tr>' + legend.reduce((total, cur) => total + '<td><b>' + cur + '</b></td>', '') + '</tr>';
      //const entryrows = data.individual.individualEntries.map(row => '<tr>' + row.reduce((total, cur) => total + '<td>' + cur + '</td>', '') + '</tr>');
      return '<table>' +legendRow + '</table>';
    }

    let logUpdate;

    function toggleLog() {
      const modal = $('#logModal');
      if (modal.hasClass('show')) {
        logInterval = undefined;
        $('#logModal').removeClass('show');
        $('#logModal').html('');
      } else {
        $('#logModal').addClass('show');
        logUpdate = () => fetch('/comlog')
          .then(res => res.json())
          .then(data => $('#logModal').html(logTable(data.legend, data.entries)));

        logUpdate()
      }
    }

    function toggleUniqueLog() {
      const modal = $('#logModal');
      if (modal.hasClass('show')) {
        logInterval = undefined;
        $('#logModal').removeClass('show');
        $('#logModal').html('');
      } else {
        $('#logModal').addClass('show');
        logUpdate = () => fetch('/comlogu')
          .then(res => res.json())
          .then(data => $('#logModal').html(logTable(data.legend, data.entries)));

        logUpdate()
      }
    }

    function toggleIndividualSL(){
      const modal = $('#logModal');
      if (modal.hasClass('show')) {
        logInterval = undefined;
        $('#logModal').removeClass('show');
        $('#logModal').html('');
      } else {
        $('#logModal').addClass('show');
        logUpdate = () => fetch('/slstate')
          .then(res => res.json())
          .then(data => $('#logModal').html(individualData(data)));

        logUpdate()
      }
    }

    socket.on('executeStart', () => { if (logUpdate) logUpdate() });

    if (!constants.exposeUpload) {
      $('#uploadButton').remove();
    }
    if (!constants.exposeShutdown) {
      $('#shutDownButton').remove();
    }
    if (config.serial.testMode) {
      $('.buttons').prepend('TEST')

    }


    for (let i = 0; i < numColumns; i++) {
      $(address(i, 0)).addClass('header');
    }

    $(address(0, 0)).html(constants.name);
    socket.on('ip', function (msg) {
      $(address(1, 0)).html(msg);
    });
    socket.on('time', function (msg) {
      $(address(2, 0)).html(printTime(msg));
      $(address(3, 0)).html(printDate(msg));
    });
    $(address(4, 0)).html(constants.QS);


    let cursor = 0;

    let logoSizeSet = false;
    for (var i = 0; i < config.serial.coms.length; i++) {
      let conf = config.serial.coms[i];
      if (conf.name === '')
        continue;


      cursor++;

      if (conf.average) {
        $(address(0, cursor + 1)).addClass('result');
        $(address(0, cursor + 1)).html(conf.name);

        $(address(1, cursor + 1)).addClass('result');
        $(address(1, cursor + 1)).html('Average ' + conf.entries);

        $(address(2, cursor + 1)).addClass('result');
        $(address(2, cursor + 1)).addClass('com' + i + 'avgtime');

        $(address(3, cursor + 1)).addClass('result');
        $(address(3, cursor + 1)).addClass('com' + i + 'avg');

        conf.entries = 1;
        config.serial.coms[i].entries = 1;
      } else {
        for (var j = 0; j < conf.entries; j++) {
          const entryCursor = cursor + conf.entries - j;
          if ((j === 0)) {
            for (let i = 0; i < numColumns - 1; i++) {
              $(address(i, entryCursor)).addClass('result');
            }
            $(address(0, entryCursor)).html(conf.name);
          }

          $(address(1, entryCursor)).html(j + 1);
          $(address(2, entryCursor)).addClass('com' + i + 'time' + j);
          $(address(3, entryCursor)).addClass('com' + i + 'entry' + j);
        }
      }

      cursor += conf.entries;

      if (!logoSizeSet) {
        logoSizeSet = true;
        $('#logo').height(Math.min(140, conf.entries * 30) * 0.95);
        fetch('/logo').then((res) => {
          if (res.ok) {
            $('#logo').attr("src", "/logo");
          }
        })
      }
    }

    cursor += 2;

    let tableUsed = false;
    let rowUsed = false;
    let newRows = Math.ceil(numTable / numColumns);
    let index = 0;

    const logButtons = $('<div class="logButtons">');

    if (config.logger.writeToFile && config.logger.unique !== 'off')
      logButtons.append('<img src="/res/LogUnique.png" height="30" width="30" onclick="javascript:toggleUniqueLog()">');
    if (config.logger.writeToFile)
      logButtons.append('<img src="/res/LogNormal.png" height="30" width="30" onclick="javascript:toggleLog()">');
    if (config.selfLearning.enabled.endsWith('ind'))
      logButtons.append('<img src="/res/selfLearning.png" height="30" width="30" onclick="javascript:toggleIndividualSL()">');

    $(address(4, cursor - 1)).append(logButtons);

    for (let i = 0; i < newRows; i++) {
      for (let j = 0; j < numColumns; j++) {
        let conf = config.table.cells[index];

        if (conf.formula) {
          rowUsed = true;
          tableUsed = true;

          $(address(j, cursor)).html(conf.name || (String.fromCharCode(65 + index % numColumns) + (index % numColumns + 1)));
          $(address(j, cursor)).addClass('table');
          if (conf.formula == '#' || conf.formula.startsWith('#M')) {
            let manual;
            if (conf.formula == '#') {
              manual = '<input style="width:' + conf.digits + 'vw" onkeyup="javascript:manualChange(' + index + ')" type="number" min="0" step="1" id="manual' + index + '">';
            } else {
              const menuOptions = conf.formula.split(',').slice(1).map(option => {
                option = option.slice(1, -1).split(':');

                return '<option value="' + option[0] + '" >' + option[1] + '</option>'
              })
                .concat(['<option selected value=""></option>'])
                .join('');
              manual = '<select style="width:' + (conf.digits * 2) + 'vw" onchange="javascript:manualChange(' + index + ')" id="manual' + index + '">' + menuOptions + '</select>';
            }

            if (conf.numeric) {
              $(address(j, cursor + 1)).append('<input style="height:33px; width:33px" value="-" onclick="javascript:manualDecrement(' + index + ')" type="button">');
              $(address(j, cursor + 1)).append(manual);
              $(address(j, cursor + 1)).append('<input style="height:33px; width:33px" value="+" onclick="javascript:manualIncrement(' + index + ')" type="button">');
            }
            else {
              $(address(j, cursor + 1)).html(manual);
            }
          }
          else {
            $(address(j, cursor + 1)).html('-');
          }
          $(address(j, cursor + 1)).addClass('table' + index);
          $(address(j, cursor + 1)).addClass('table');
        }
        index++;
      }

      if (rowUsed) {
        cursor += 2;
      }


      rowUsed = false;
    }

    if (tableUsed) {
      cursor++;
    }

    newRows = Math.ceil(numOutputs / numColumns);
    index = 0;
    for (let i = 0; i < newRows; i++) {
      for (let j = 0; j < numColumns; j++) {
        let conf = config.output.ports[index];

        if (conf.formula) {
          rowUsed = true;

          let argument = index;
          $(address(j, cursor)).html(conf.name);
          $(address(j, cursor)).addClass('output' + index);
          $(address(j, cursor)).addClass('output off');
          $(address(j, cursor)).click(function () { clickOutput(argument) });
        }
        index++;
      }
      if (rowUsed)
        cursor += 2;

      rowUsed = false;
    }

    newRows = Math.ceil(numInputs / numColumns);
    index = 0;
    for (let i = 0; i < newRows; i++) {
      for (let j = 0; j < numColumns; j++) {
        let conf = config.input.ports[i * numColumns + j];

        if (conf.name) {
          rowUsed = true;

          let argument = index;
          $(address(j, cursor)).html(conf.name);
          $(address(j, cursor)).addClass('input' + index);
          $(address(j, cursor)).addClass('input off');
          $(address(j, cursor)).click(function () { clickInput(argument) });
        }
        index++;
      }
      if (rowUsed)
        cursor += 2;

      rowUsed = false;
    }
    var previousEntry = [];
    var previousTime = [];
    for (var i = 0; i < config.serial.coms.length; i++) {
      previousEntry[i] = '';
      previousTime[i] = 0;
    }

    socket.on('entry', function (msg) {
      const { index, entryTime, entry } = msg;

      if ($('.com' + index + 'entry0').html())
        shiftEntries(index);

      if (!entryTime) {
        $('.com' + index + 'time0').html('');
        $('.com' + index + 'entry0').html('');
      } else {
        $('.com' + index + 'time0').html(printTime(entryTime));
        $('.com' + index + 'entry0').html(entry);
      }
    });

    socket.on('table', function (msg) {
      if (msg.manual) {
        $('#manual' + msg.index).val(msg.value);
      } else {
        $('.table' + msg.index).html(msg.value);
      }
    });

    socket.on('state', function (msg) {
      $('.' + msg.name).removeClass('on off forcedOn forcedOff execute').addClass(msg.state);
    })

    socket.on('average', function (msg) {
      const { index, average, entryTime } = msg;

      $('.com' + index + 'avg').html(average);
      $('.com' + index + 'avgtime').html(printTime(entryTime));
    });

    socket.on('notfound', function (msg) {
      $('.table').removeClass('notfound');
      if (msg) {
        $('.table').addClass('notfound');
      }
    });

    socket.on('error', function (msg) {
      alert(msg);
    });

    socket.on('cleartable', function () {
      for (var i = 0; i < config.table.cells.length; i++) {
        const cell = config.table.cells[i];
        if (!cell.resetOnExe) {
          if (cell.formula == '#' || cell.formula.startsWith('#M')) {
            manualChange(i);
          }
          continue;
        }

        if (cell.formula == '#' || cell.formula.startsWith('#M')) {
          $('#manual' + i).val('');
        }
        else {
          $('.table' + i).html('');
        }
      }
    });

    socket.on('clearserial', function () {
      for (var i = 0; i < config.serial.coms.length; i++) {
        if ($('.com' + i + 'time0').html())
          shiftEntries(i);

        $('.com' + i + 'time0').html('');
        $('.com' + i + 'entry0').html('');
      }
    });

    if (config.selfLearning.enabled !== 'off') {
      socket.on('selfLearning', (msg) => {
        console.log(msg)
        const { calibration, tolerance, success, matchedTolerance } = msg;
        let color;

        if (success) {
          $(address(2, 1)).html((Math.round(tolerance * 1000) / 10) + '% ');
          $(address(3, 1)).html((Math.round(1000 * (tolerance - matchedTolerance)) / 10) + '% ');

          if ((tolerance - matchedTolerance) < 0) {
            color = 'warning';
          } else {
            color = 'done';
          }
        } else {
          $(address(2, 1)).html((Math.round(tolerance * 1000) / 10) + '% ');
          $(address(3, 1)).html('');

          color = 'inProgress';
        }
        const selfLearningIndex = Number(config.selfLearning.enabled.slice(3));
        $(address(1, 1)).html(calibration.toFixed(config.serial.coms[selfLearningIndex].digits));

        for (let i = 1; i < 4; i++) {
          $(address(i, 1)).removeClass('inProgress done warning');
          $(address(i, 1)).addClass('selfLearning ' + color);
        }
      });
    }
  </script>
</body>

</html>