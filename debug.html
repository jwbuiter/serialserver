<!doctype html>
<html>
<head>
  <title>MBDCcomUnit</title>
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box;}
      body { font-style: : Helvetica, Arial; font-size: 0px;}
      table { width: 100%; text-align: center; border: none; border-collapse: collapse;}
      tr { height: 29px; }
      td { text-align: center; font-size: 25px; border-style: bold;}
      input { text-align: center; font-size: 25px; border-style: bold; }
      .header { background-color: yellow; font-weight: bold;}
      .result { background-color: #98FB98;}
      .buttons {position: fixed; right: 0; top: 30px; font-size:20px;}
      .logo {position: fixed; left: 0; top: 30px;}
      .table{ font-size: 30px; color: black; background-color: cyan; font-weight: bold;}
      .output.off{ background-color: #98FB98; }
      .output.on{ background-color: red;}
      .output.execute{ background-color: #FFC000; }
      .output.forcedOn{ background-color: #CC66FF; }
      .output.forcedOff{ background-color: #FFCCFF; }
      .input.off{ background-color: #CCFFCC; }
      .input.on{ background-color: yellow;}
      .input.forcedOn{background-color: #CC66FF; }
      .input.forcedOff{ background-color: #FFCCFF; }
      #fileLoader {font-size: 30px; }
    </style>
</head>
<body>
  <table id="content">
  </table>
  <div class = "buttons">
    <img id = "uploadButton" src = "/res/upload.png" height="30" width="30" onclick="javascript:goFileUpload()">

    <img src = "/res/settings.svg" height="30" width="30" onclick="javascript:goSettings()">

    <img src = "/res/restart.ico"  height="30" width="30" onclick="javascript:goRestart()">
    
    <img id = "shutDownButton" src = "/res/shutdown.ico" height="30" width="30" onclick="javascript:goShutdown()">
  </div>
  <div class = "logo">
    <img id = "logo" src = "/res/mbdc.jpg">
  </div>
  <script src="/socket.io/socket.io.js"></script>
  <script src="/res/jquery-1.11.1.js"></script>
  <script src="/config.js"></script>
  <script>
    var socket = io();
    const numColumns = 5;
    const numRows = 24;

    const numTable = config.table.length;

    const numOutputs = config.output.length;
    const numInputs = config.input.length;

    function address(rowNum, columnNum){
      return '#c' + columnNum + 'r' + rowNum;
    }

    function goSettings(){
      if (confirm("Do you want to go to the settings?")){
        window.location.href = '/settings'; //relative to domain
      }
    }

    function goShutdown(){
      if (confirm("Do you really want to shut down?")){
        window.location.href = '/shutdown'; //relative to domain
      }
    }

    function goRestart(){
      if (confirm("Do you really want to restart?")){
        window.location.href = '/restart'; //relative to domain
      }
    }

    function goFileUpload(){
      if (confirm("Do you really want to upload a file?")){
        window.location.href = '/fileupload'; //relative to domain
      }
    }

    function clickOutput(index){
      socket.emit('forceOutput', index);
    }

    function clickInput(index){
      socket.emit('forceInput', index);
    }

    function printDate(time){
      var date = new Date(time);
      return date.getDate() + '-' + (date.getMonth()+1) + '-' + (date.getYear()+1900);
    }
    function printTime(time){
      var date = new Date(time);
      return date.getHours() + ':' + ("0" + date.getMinutes()).slice(-2) + ':' + ("0" + date.getSeconds()).slice(-2);
    }


    if (!config.exposeUpload){
      $('#uploadButton').remove();
    }
    if (config.testMode){
      $('#shutDownButton').remove();
    }

    for (let i = 0; i < numRows; i++){
      var currentRow = $('<tr>');
      $('#content').append(currentRow);
      for (let j = 0; j < numColumns; j++){
        currentRow.append($('<td>').attr('id', address(j, i).slice(1)));
      }
    }

    for (let i = 0; i < numColumns; i++){
      $(address(i, 0)).addClass('header');
    }

    $(address(0, 0)).html(config.name); 
    socket.on('ip', function(msg){
      $(address(1, 0)).html(msg);
    });
    socket.on('time', function(msg){
      $(address(2, 0)).html(printTime(msg));
      $(address(3, 0)).html(printDate(msg));
    });
    $(address(4, 0)).html(config.QS);


    let cursor = 0;

    let logoSizeSet = false;
    for (var i = 0; i<config.serial.length; i++){
      let conf = config.serial[i];
      if (conf.name==='')
        continue;

      if (!logoSizeSet)
      {
        logoSizeSet = true;
        $('#logo').height(Math.min(140, conf.entries*30)*0.95);
      }

      cursor ++;

      for (var j = 0; j<conf.entries; j++){
        cursor++;
        if((j===conf.entries-1)){
          for (let i = 0; i < numColumns-1; i++){
            $(address(i, cursor)).addClass('result');
          }
          $(address(0, cursor)).html(conf.name);
          if (conf.average){
            $(address(4, cursor)).addClass(conf.name + 'avg')
            $(address(4, cursor)).addClass('result');
          }
        }
        if (j===conf.entries-2 && conf.average)
          $(address(4, cursor)).html( 'Average' );

        $(address(1, cursor)).html(j+1);
        $(address(2, cursor)).addClass(conf.name+'time'+j);
        $(address(3, cursor)).addClass(conf.name+'entry'+j);
      }
    }

    cursor +=2;
  
    for (let i = 0; i < numTable; i++){
      let conf = config.table[i];

      if (!conf.formula)
        continue;

      $(address(i % numColumns, cursor +  2*Math.floor(i/numColumns))).html(conf.name || (String.fromCharCode(65 + i % numColumns) + (i % numColumns + 1)));
      $(address(i % numColumns, cursor +  2*Math.floor(i/numColumns))).addClass('table');
      if (conf.formula == '#'){
        $(address(i % numColumns, cursor +  2*Math.floor(i/numColumns) + 1)).html('<input type="text" id="manual' + i + '">')
      }
      else{
        $(address(i % numColumns, cursor +  2*Math.floor(i/numColumns) + 1)).html('-')
      }
      $(address(i % numColumns, cursor +  2*Math.floor(i/numColumns) + 1)).addClass('table'+i);
      $(address(i % numColumns, cursor +  2*Math.floor(i/numColumns) + 1)).addClass('table');
    }

    cursor += 2 * numTable/numColumns + 1;

    for (let i = 0; i < numOutputs; i++){
      let conf = config.output[i];

      if (!conf.formula)
        continue;

      $(address(i % numColumns, cursor +  2*Math.floor(i/numColumns))).html(conf.name );
      $(address(i % numColumns, cursor +  2*Math.floor(i/numColumns))).addClass('output'+i);
      $(address(i % numColumns, cursor +  2*Math.floor(i/numColumns))).addClass('output off');
      $(address(i % numColumns, cursor +  2*Math.floor(i/numColumns))).click(function (){ clickOutput(i)});
    }
   
    cursor +=2* numOutputs/numColumns ;

    for (let i = 0; i < numInputs; i++){
      let conf = config.input[i];

      $(address(i % numColumns, cursor +  Math.floor(i/numColumns))).html(conf.name );
      $(address(i % numColumns, cursor +  Math.floor(i/numColumns))).addClass('input'+i);
      $(address(i % numColumns, cursor +  Math.floor(i/numColumns))).addClass('input off');
      $(address(i % numColumns, cursor +  Math.floor(i/numColumns))).click(function (){ clickInput(i)});
    }

    var previousEntry = [];
    var previousTime = [];
    for(var i = 0; i<config.serial.length; i++){
      previousEntry[i] = '';
      previousTime[i] = 0;
    }

    socket.on('entry', function(msg){
      for(var i = 0; i<config.serial.length; i++)
        if (msg.name===config.serial[i].name)
          break;  //store value of i for correct serial entry
        
      var date = new Date()
      if (msg.entry==previousEntry[i] && date.getTime()<previousTime[i] + config.serial[i].timeout*1000)
        return;

      previousTime[i]=date.getTime();
      previousEntry[i]=msg.entry;


      for(var j = 0; j<config.serial[i].entries; j++){
        if (j<config.serial[i].entries-1){
          $('.' + config.serial[i].name+'time'+j).html($('.' + config.serial[i].name+'time'+(j + 1)).html());
          $('.' + config.serial[i].name+'entry'+j).html($('.' + config.serial[i].name+'entry'+(j + 1)).html());
        }
        else{
          $('.' + config.serial[i].name+'time'+j).html(printTime(msg.entryTime));
          $('.' + config.serial[i].name+'entry'+j).html(msg.entry);
        }
      }
    });

    socket.on('value', function(msg){
      $('.'+msg.name).html(msg.value);
    });

    socket.on('state', function(msg){
      $('.'+msg.name).removeClass('on off forcedOn forcedOff execute').addClass(msg.state);
    })

    socket.on('average', function(msg){
      for(var i = 0; i<config.serial.length; i++)
        if (msg.name===config.serial[i].name){
          $('.' + config.serial[i].name+'avg').html(msg.entry);
        }
    });
  </script>
</body>
</html>