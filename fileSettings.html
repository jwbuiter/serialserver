<!doctype html>
<html>
<head>
  <title>MBDCcomUnit</title>
   <style>
      *{font-size: 25px; padding:0;}
      table { text-align: center; border: none; border-collapse: collapse;}
      tr { height: 29px; }
      td { text-align: center;  border-style: bold; width: 12vw; height: 29px;}
      td.small { font-size: 15px; }
      input {text-align: center; width: 11vw;}
      input.wide {width: 28vw;}
      input[type="submit"]{width: auto;}
      select { width: 12vw; }
      select.wide {width: 28vw;}
    </style>
</head>
<body>
  <div style="display: block; margin:0 auto;">
    <table id="content">
    </table>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script src="/res/jquery-1.11.1.js"></script>
  <script src="/config.js"></script>
  <script type="text/javascript">
    var socket = io();
    const numColumns = 7;
    var numRows = 0;
    const tableNumbers = 5;
    const tableLetters = 2;
    const numOutputs = 10;
    const numInputs = 5;

    function address(columnNum, rowNum){
      while (rowNum>=numRows){
        console.log(numRows);
        var currentRow = $('<tr>');
        $('#content').append(currentRow);
        for (let i = 0; i < numColumns; i++){
          currentRow.append($('<td>').attr('id', 'c' + i + 'r' + numRows));
        }
        numRows++;
      }
      return '#c' + columnNum + 'r' + rowNum;
    }

    $(address(0, 0)).append($('<b>').html('Trigger'));
    $(address(1, 0)).append($('<b>').html('Search Column'));
    $(address(2, 0)).append($('<b>').html('Wait for second COM'));
    $(address(3, 0)).append($('<b>').html('Save to file'));
    $(address(2, 2)).append($('<b>').html('Use file'));
    $(address(3, 2)).append($('<b>').html('Test mode'));
    $(address(5, 0)).append($('<input type="button" value="Cancel" onclick="javascript:goDebug()">'));
    $(address(6, 0)).append($('<input type="button" value="Save" onclick="javascript:setSettings()">'));
    $(address(5, 1)).append($('<input type="button" value="Save config" onclick="javascript:saveConfig()">'));
    $(address(6, 1)).append($('<input type="button" value="Load config" onclick="javascript:loadConfig()">'));
    $(address(0, 1)).append($('<select id ="triggerCom">').html('<option value="0">COM 0</option><option value="1">COM 1</option>'));
    $(address(1, 1)).append($('<input type="text" id="searchColumn">'));
    $(address(2, 1)).append($('<input type="checkbox" id="waitForOther">'));
    $(address(3, 1)).append($('<input type="checkbox" id="saveToFile">'));
    $(address(2, 3)).append($('<input type="checkbox" id="useFile">'));
    $(address(3, 3)).append($('<input type="checkbox" id="testMode">'));
    
    var cursor = 5;

    $(address(0, cursor)).append($('<b>').html('Table'));
    $(address(1, cursor)).append($('<b>').html('Name'));
    $(address(2, cursor)).append($('<b>').html('Formula'));
    $(address(3, cursor)).append($('<b>').html('Numeric'));
    $(address(4, cursor)).append($('<b>').html('Digits/round.'));
    $(address(5, cursor)).append($('<b>').html('Command'));
    $(address(6, cursor)).append($('<b>').html('Value'));
    var commands = [
      'com0',
      'com1',
      'date',
      '$A',
      '#A1',
      '#O1',
      '#I1',
      '#',
      'and',
      'or',
      '( )',
      '==',
      '!=',
      '>',
      '>=',
      '<',
      '<=',
      '+',
      '-',
      '*',
      '/',
    ];
    var meanings = [
      'value com0',
      'value com1',
      'date today',
      'value input-file column A',
      'value table #A1',
      'value output 1 (0 or 1)',
      'value input 1 (0 or 1)',
      'manual input',
      'meets both commands',
      'meets 1 of the commands',
      'priority',
      'equal to',
      'not equal to',
      'greater than',
      'greater or equal to',
      'less than',
      'less or equal to',
      'add',
      'substract',
      'multiply',
      'divide',
    ];
    cursor++;
    for (let i = 0; i < commands.length; i++){
      $(address(5, i + cursor)).html(commands[i]);
      $(address(5, i + cursor)).addClass('small');
      $(address(6, i + cursor)).html(meanings[i]);
      $(address(6, i + cursor)).addClass('small');
    }
    
    for (let i = 0; i < tableLetters; i++){
      for (let j = 0; j < tableNumbers; j++){
        $(address(0, cursor)).append($('<b>').html('#' + String.fromCharCode(65 + i) + (j + 1)));
        $(address(1, cursor)).append($('<input type="text" id="nameTable' + (i*tableNumbers + j) + '">'));
        $(address(2, cursor)).append($('<input class="wide" type="text" id="formulaTable' + (i*tableNumbers + j) + '">'));
        $(address(3, cursor)).append($('<input type="checkbox" id="numericTable' + (i*tableNumbers + j) +'">'));
        $(address(4, cursor)).append($('<input type="number" id="digitsTable' + (i*tableNumbers + j) + '" min="0" step="1">'));
        cursor++;
      }
    }
      
    cursor ++;
    $(address(1, cursor)).append($('<b>').html('Name'));
    $(address(2, cursor)).append($('<b>').html('Formula'));
    $(address(3, cursor)).append($('<b>').html('Execute'));
    $(address(4, cursor)).append($('<b>').html('Seconds'));
    cursor++;
    for (let i = 0; i < numOutputs; i++){
      $(address(0, cursor)).append($('<b>').html('Output ' + (i + 1)));
      $(address(1, cursor)).append($('<input type="text" id="nameOutput' + i + '">'));
      $(address(2, cursor)).append($('<input class="wide" type="text" id="formulaOutput' + i + '">'));
      $(address(3, cursor)).append($('<input type="checkbox" id="executeOutput' + i + '">'));
      $(address(4, cursor)).append($('<input type="number" id="secondsOutput' + i + '" min="0" step="1">'));
      cursor++;
    }
    cursor++;
    $(address(1, cursor)).append($('<b>').html('Name'));
    $(address(2, cursor)).append($('<b>').html('Command'));
    cursor++;
    for (let i = 0; i < numInputs; i++){
      $(address(0, cursor)).append($('<b>').html('Input ' + (i + 1)));
      $(address(1, cursor)).append($('<input type="text" id="nameInput' + i + '">'));
      $(address(2, cursor)).append($('<select selected=" " class="wide" id="formulaInput' + i + '">').html('<option value=""></option><option value="exe">Execute</option><option value="exebl">Execute block</option>'));
      cursor++;
    }
    function fillIn(){
      for (var i = 0; i < 10; i++)
      {
        var conf = config.table[i];
        Object.keys(conf).forEach(function(key) 
        {
          console.log(key)
          let target = $(`#${key}Table${i}`);
          if (typeof(conf[key]) === "boolean")
          {
            target.prop('checked', conf[key]);
          }
          else
          {
           target.val(conf[key]);
          }
        });
      }
      for (var i = 0; i < 10; i++)
      {
        var conf = config.output[i];
        Object.keys(conf).forEach(function(key) 
        {
          let target = $(`#${key}Output${i}`);
          if (typeof(conf[key]) === "boolean")
          {
            target.prop('checked', conf[key]);
          }
          else
          {
           target.val(conf[key]);
          }
        });
      }
      for (var i = 0; i < 5; i++)
      {
        var conf = config.input[i];
        Object.keys(conf).forEach(function(key) 
        {
          let target = $(`#${key}Input${i}`);
          if (typeof(conf[key]) === "boolean")
          {
            target.prop('checked', conf[key]);
          }
          else
          {
           target.val(conf[key]);
          }
        });
      }
      $('#triggerCom').val(config.triggerCom);
      $('#searchColumn').val(config.searchColumn);
      $('#waitForOther').prop('checked', config.waitForOther);
      $('#saveToFile').prop('checked', config.saveToFile);
      $('#useFile').prop('checked', config.useFile);
      $('#testMode').prop('checked', config.testMode);
    }

    function putInConfig(){
      for (var i = 0; i < 10; i++)
      {
        var conf = config.table[i];
        Object.keys(conf).forEach(function(key) 
        {
          let element = $(`#${key}Table${i}`);
          if (element.length!=0)
          {
            if (typeof(conf[key]) === "boolean")
            {
              conf[key] = element.prop('checked');
            }
            else if (typeof(conf[key]) === 'number')
            {
              conf[key] = Number(element.val());
            }
            else
            {
              conf[key] = element.val();
            }
          }
        });
        var conf = config.output[i];
        Object.keys(conf).forEach(function(key) 
        {
          let element = $(`#${key}Output${i}`);
          if (element.length!=0)
          {
            if (typeof(conf[key]) === "boolean")
            {
              conf[key] = element.prop('checked');
            }
            else if (typeof(conf[key]) === 'number')
            {
              conf[key] = Number(element.val());
            }
            else
            {
              conf[key] = element.val();
            }
          }
        });
      }
      for (var i = 0; i < 5; i++)
      {
        var conf = config.input[i];
        Object.keys(conf).forEach(function(key) 
        {
          let element = $(`#${key}Input${i}`);
          if (element.length!=0)
          {
            if (typeof(conf[key]) === "boolean")
            {
              conf[key] = element.prop('checked');
            }
            else if (typeof(conf[key]) === 'number')
            {
              conf[key] = Number(element.val());
            }
            else
            {
              conf[key] = element.val();
            }
          }
        });
      }
      config.triggerCom = Number($('#triggerCom').val());
      config.searchColumn = Number($('#searchColumn').val());
      config.waitForOther = $('#waitForOther').prop('checked');
      config.saveToFile = $('#saveToFile').prop('checked');
      config.useFile = $('#useFile').prop('checked');
      config.testMode = $('#testMode').prop('checked');
    } 
    function setDate(){
      let dateTimeString = $('#date').val() + ' ' + $('#time').val()
      let dateTime = Date.parse(dateTimeString);
      socket.emit('setDateTime', dateTime/1000);
    }
    function goSubmit(){
      $('#uploadForm').submit();
    }
    function goDebug(){
      window.location.href = '/';
    }
    function saveConfig(){
      putInConfig();
      let conf = JSON.stringify(config, null, 2).replace(/"/g, "'")
      .replace(/\\u00[0-9]{2}/g, match => String.fromCharCode(parseInt(match.slice(-2), 16)))
      .replace(/'[\w]+':/g, match => match.slice(1,-2)+' :');
      conf = 'var config =' + conf + ';\n\nmodule.exports = config;';

      var file = new Blob([conf]);
      if (window.navigator.msSaveOrOpenBlob) // IE10+
          window.navigator.msSaveOrOpenBlob(file, 'config.js');
      else { // Others
          var a = document.createElement("a"),
                  url = URL.createObjectURL(file);
          a.href = url;
          a.download = 'config.js';
          document.body.appendChild(a);
          a.click();
          setTimeout(function() {
              document.body.removeChild(a);
              window.URL.revokeObjectURL(url);  
          }, 0); 
      }
    }
    function setSettings(){
      if (confirm("Do you really want to save these settings??"))
      {
        putInConfig()
        
        socket.emit('settings',config);
        setTimeout(function(){ 
          window.location.href = '/';
        }, 5000);
      }
    }
    fillIn();
  </script>
</body>
</html>