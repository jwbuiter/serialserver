<!doctype html>
<html>
<head>
  <title>MBDCcomUnit</title>
   <style>
      *{font-size: 25px; padding:0; margin: 0; }
      table { text-align: center; border: none; border-collapse: collapse;}
      tr { height: 29px; }
      td { position: relative; text-align: center;  border-style: bold; height: 29px;}
      td.right { text-align: right; }
      .small { font-size: 15px; }
      input {text-align: center; width: 100%;}
      input[type="submit"]{width: auto;}
      input[type="time"]{font-size: 19px;}
      input.config {width: 20%; float:right; font-size: 20px;}
      select { width: 100%;}
      #list {width: 50vw;text-align: left; position: absolute; right: 100%; top: 1.5em; z-index: 2; background-color: white; border: 1px solid black; padding: 5px;}
      ul { list-style-type: none;}
      li {margin: 0 0 3px 0;}
    </style>
</head>
<body>
  <div>
    <table id="content">
    </table>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script src="/res/jquery-1.11.1.js"></script>
  <script src="/config.js"></script>
  <script src="/config.static.js"></script>
  <script type="text/javascript">
    if (screen.width>1000){
      var columnWidths = [12, 12, 28, 12, 12, 12, 12, 12];
    }
    else{
      var columnWidths = [14, 14, 23, 12, 18, 18, 18, 18];
      $('#content').css('width', columnWidths.reduce(function(acc, val) { return acc + val; }) + 'vw');
    }
    
    var socket = io();
    var configList;

    const numColumns = 8;
    var numRows = 0;
    const tableNumbers = 5;
    const tableLetters = 2;
    const numOutputs = 10;
    const numInputs = 5;

    function address(columnNum, rowNum){
      while (rowNum>=numRows){
        var currentRow = $('<tr>');
        $('#content').append(currentRow);
        for (let i = 0; i < numColumns; i++){
          var newCell = $('<td>').attr('id', 'c' + i + 'r' + numRows);
          newCell.css('max-width', columnWidths[i] + 'vw');
           newCell.css('width', columnWidths[i] + 'vw');
          currentRow.append(newCell);
        }
        numRows++;
      }
      return '#c' + columnNum + 'r' + rowNum;
    }

    $(address(0, 0)).append($('<b>').html('Trigger'));
    $(address(1, 0)).append($('<b>').html('Use import file'));
    $(address(2, 0)).append($('<b>').html('Wait for second COM'));
    $(address(3, 0)).append($('<b>').html('Search Column'));
    $(address(4, 0)).append($('<b>').html('Save to file'));

    $(address(0, 1)).append($('<select id ="triggerCom">').html('<option value="0">COM 0</option><option value="1">COM 1</option>'));
    $(address(1, 1)).append($('<input type="checkbox" id="useFile">'));
    $(address(2, 1)).append($('<input type="checkbox" id="waitForOther">'));
    $(address(3, 1)).append($('<input type="text" id="searchColumn">'));
    $(address(4, 1)).append($('<input type="checkbox" id="saveToFile">'));

    $(address(5, 0)).append($('<input type="button" value="Save" onclick="javascript:setSettings()">'));
    $(address(6, 0)).append($('<input type="button" value="Save config" onclick="javascript:saveConfig()">'));
    $(address(7, 0)).append($('<b>').html('Version: '+config.version));
    $(address(5, 1)).append($('<input type="button" value="Cancel" onclick="javascript:goDebug()">'));
    $(address(6, 1)).append($('<input type="button" value="Load config" onclick="javascript:loadConfigList()">'));
    $(address(7, 1)).append($('<input type="button" value="Load default" onclick="javascript:loadDefault()">'));
    

    for (let i = 0; i<7; i++){
      $(address(i, 2)).append($('<hr>'));
    }

    $(address(0, 3)).append($('<b>').html('File reset'));
    $(address(1, 3)).append($('<b>').html('Time'));
    $(address(2, 3)).append($('<b>').html('Automatic FTP'));
    $(address(3, 3)).append($('<b>').html('1-Address / Folder'));
    $(address(4, 3)).append($('<b>').html('1-User : Password'));
    $(address(5, 3)).append($('<b>').html('2-Address / Folder'));
    $(address(6, 3)).append($('<b>').html('2-User : Password'));

    $(address(0, 4)).append($('<select id ="resetFile">').html('<option value="off">Off</option><option value="interval">Interval</option><option value="time">Time of day</option>'));
    $(address(1, 4)).append($('<input type="time" id="fileResetValue">'));
    $(address(2, 4)).append($('<input type="checkbox" id="autoFTP">'));
    $(address(3, 4)).append($('<input type="text" style="font-size: 19px" id="addressFolderFTP0">'));
    $(address(4, 4)).append($('<input type="text" style="font-size: 19px" id="userPasswordFTP0">'));
    $(address(5, 4)).append($('<input type="text" style="font-size: 19px" id="addressFolderFTP1">'));
    $(address(6, 4)).append($('<input type="text" style="font-size: 19px" id="userPasswordFTP1">'));

    for (let i = 0; i<8; i++){
      $(address(i, 5)).append($('<hr>'));
    }

    var cursor = 6;

    if(constants.selfLearning){

      $(address(0, 6)).append($('<b>').html('Self-learning'));
      $(address(1, 6)).append($('<b>').html('Number'));
      $(address(2, 6)).append($('<b>').html('Tolerance(%)'));
      $(address(3, 6)).append($('<b>').html('#SCmin'));
      $(address(4, 6)).append($('<b>').html('#SCmax'));
      $(address(5, 6)).append($('<b>').html('Reset'));
      $(address(6, 6)).append($('<b>').html('Time'));
      $(address(7, 6)).html('#SC #SCmin #SCmax').addClass('small');
      

      $(address(0, 7)).append($('<select id ="selfLearning">').html('<option value="off">Off</option><option value="com1">Com 0</option><option value="com1">Com 1</option>'));
      $(address(1, 7)).append($('<input type="number" id="selfLearningNumber" min="0" step="1">'));
      $(address(2, 7)).append($('<input type="number" id="selfLearningTolerance" min="0" step="1">'));
      $(address(3, 7)).append($('<input type="number" id="calibrationMin" min="0" step="1">'));
      $(address(4, 7)).append($('<input type="number" id="calibrationMax" min="0" step="1">'));
      $(address(5, 7)).append($('<select id ="selfLearningReset">').html('<option value="off">Off</option><option value="fileReset">File Reset</option><option value="interval">Interval</option><option value="time">Time of day</option>'));
      $(address(6, 7)).append($('<input type="time" id="selfLearningResetValue">'));
      $(address(7, 7)).html('#SN #ST').addClass('small');

      for (let i = 0; i<8; i++){
        $(address(i, 8)).append($('<hr>'));
      }
      cursor+=3;
    }
    cursor++;

    $(address(0, cursor)).append($('<b>').html('Table'));
    $(address(1, cursor)).append($('<b>').html('Name'));
    $(address(2, cursor)).append($('<b>').html('Formula'));
    $(address(3, cursor)).append($('<b>').html('Numeric'));
    $(address(4, cursor)).append($('<b>').html('Digits/round.'));
    $(address(5, cursor)).append($('<b>').html('Reset on exe'));
    $(address(6, cursor)).append($('<b>').html('Command').addClass('small'));
    $(address(7, cursor)).append($('<b>').html('Value').addClass('small'));
    var commands = [
      'com0',
      'date',
      '$A',
      '#A1',
      '#O1',
      '#I1',
      '#',
      'and',
      'or',
      '( )',
      '==',
      '!=',
      '>',
      '>=',
      '<',
      '<=',
      '+',
      '-',
      '*',
      '/',
      '#SC #SCmin #SCmax',
      '#SN',
      '#ST'
    ];
    var meanings = [
      'value com0',
      'date today',
      'value input-file column A',
      'value table #A1',
      'value output 1 (0 or 1)',
      'value input 1 (0 or 1)',
      'manual input',
      'meets both commands',
      'meets 1 of the commands',
      'priority',
      'equal to',
      'not equal to',
      'greater than',
      'greater or equal to',
      'less than',
      'less or equal to',
      'add',
      'substract',
      'multiply',
      'divide',
      'self-learning calibration',
      'self-learning number',
      'self-learning time'
    ];
    cursor++;
    for (let i = 0; i < commands.length; i++){
      $(address(6, i + cursor)).html(commands[i]);
      $(address(6, i + cursor)).addClass('small');
      $(address(7, i + cursor)).html(meanings[i]);
      $(address(7, i + cursor)).addClass('small');
    }
    
    for (let i = 0; i < tableLetters; i++){
      for (let j = 0; j < tableNumbers; j++){
        $(address(0, cursor)).append($('<b>').html('#' + String.fromCharCode(65 + i) + (j + 1)));
        $(address(1, cursor)).append($('<input type="text" id="nametable' + (i*tableNumbers + j) + '">'));
        $(address(2, cursor)).append($('<input class="wide" type="text" id="formulatable' + (i*tableNumbers + j) + '">'));
        $(address(3, cursor)).append($('<input type="checkbox" id="numerictable' + (i*tableNumbers + j) +'">'));
        $(address(4, cursor)).append($('<input type="number" id="digitstable' + (i*tableNumbers + j) + '" min="0" step="1">'));
        $(address(5, cursor)).append($('<input type="checkbox" id="resetOnExetable' + (i*tableNumbers + j) +'">'));
        cursor++;
      }
    }
    cursor ++;

    $(address(1, cursor)).append($('<b>').html('Name'));
    $(address(2, cursor)).append($('<b>').html('Formula'));
    $(address(3, cursor)).append($('<b>').html('Execute'));
    $(address(4, cursor)).append($('<b>').html('Seconds'));
    cursor++;

    for (let i = 0; i < numOutputs; i++){
      $(address(0, cursor)).append($('<b>').html('Output ' + (i + 1)));
      $(address(1, cursor)).append($('<input type="text" id="nameoutput' + i + '">'));
      $(address(2, cursor)).append($('<input class="wide" type="text" id="formulaoutput' + i + '">'));
      $(address(3, cursor)).append($('<input type="checkbox" id="executeoutput' + i + '">'));
      $(address(4, cursor)).append($('<input type="number" id="secondsoutput' + i + '" min="0" step="1">'));
      cursor++;
    }
    cursor++;

    $(address(1, cursor)).append($('<b>').html('Name'));
    $(address(2, cursor)).append($('<b>').html('Command'));
    $(address(3, cursor)).append($('<b>').html('Invert'));
    $(address(4, cursor)).append($('<b>').html('Follow'));
    $(address(5, cursor)).append($('<b>').html('Timeout'));
    $(address(6, cursor)).append($('<b>').html('Logfile').addClass('small'));
    $(address(7, cursor)).append($('<b>').html('X: 0/1/A1/B5').addClass('small'));
    var commands = [
      '&tn',
      '&toX',
      '&miX',
      '&maX',
      '&spX',
    ];
    var meanings = [
      'total number',
      'total',
      'minimum',
      'maximum',
      'spread',
    ];
    cursor++;
    for (let i = 0; i < commands.length; i++){
      $(address(6, i + cursor)).html(commands[i]);
      $(address(6, i + cursor)).addClass('small');
      $(address(7, i + cursor)).html(meanings[i]);
      $(address(7, i + cursor)).addClass('small');
    }

    for (let i = 0; i < numInputs; i++){
      $(address(0, cursor)).append($('<b>').html('Input ' + (i + 1)));
      $(address(1, cursor)).append($('<input type="text" id="nameinput' + i + '">'));

      let commandSelect = $('<select selected=" " class="wide" id="formulainput' + i + '">');
      commandSelect.append('<option value=""></option><option value="exe">Execute</option><option value="exebl">Execute block</option>');
      $(address(2, cursor)).append(commandSelect);
      $(address(3, cursor)).append($('<input type="checkbox" id="invertinput' + i + '">'));

      let followSelect = $('<select selected="-1" id="followinput' + i + '">');
      followSelect.append('<option value="-1">None</option>');
      for (let j = 0; j < numOutputs; j++){
        followSelect.append('<option value="'+j+'"">Output '+(j+1)+'</option>');
      }
      $(address(4, cursor)).append(followSelect);
      $(address(5, cursor)).append($('<input type="number" id="timeoutinput' + i + '" min="0" step="1">'));
      
      cursor++;
      address(3, cursor);
    }



    function fillIn(){
      for (let property in config){
        if (typeof(config[property])==='object'){
          for (let i = 0; i<config[property].length; i++){
            let element = (config[property])[i];

            for (let subproperty in element){
              let source = $('#'+subproperty+property+i);

              if (!source.length) continue;

              switch (typeof(element[subproperty])){
                case 'boolean':
                  source.prop('checked', element[subproperty]);
                  break;
                case 'number':
                  source.val(element[subproperty]);
                  break;
                case 'string':
                  source.val(element[subproperty]);
                  break;
              }
            }
          }
        }
        else {
          let source = $('#'+property);

          if (!source.length) continue;

          switch (typeof(config[property])){
            case 'boolean':
              source.prop('checked', config[property]);
              break;
            case 'number':
              source.val(config[property]);
              break;
            case 'string':
              source.val(config[property]);
              break;
          }
        }
      }
    }

    function putInConfig(){
      for (let property in config){
        if (typeof(config[property])==='object'){
          for (let i = 0; i<config[property].length; i++){
            let element = (config[property])[i];

            for (let subproperty in element){
              let source = $('#'+subproperty+property+i);

              if (!source.length) continue;

              switch (typeof(element[subproperty])){
                case 'boolean':
                  element[subproperty] = source.prop('checked');
                  break;
                case 'number':
                  element[subproperty] = Number(source.val());
                  break;
                case 'string':
                  element[subproperty] = source.val();
                  break;
              }
            }
          }
        }
        else {
          let source = $('#'+property);

          if (!source.length) continue;

          switch (typeof(config[property])){
            case 'boolean':
              config[property] = source.prop('checked');
              break;
            case 'number':
              config[property] = Number(source.val());
              break;
            case 'string':
              config[property] = source.val();
              break;
          }
        }
      }
    } 


    function setDate(){
      let dateTimeString = $('#date').val() + ' ' + $('#time').val()
      let dateTime = Date.parse(dateTimeString);
      socket.emit('setDateTime', dateTime/1000);
    }
    function goSubmit(){
      $('#uploadForm').submit();
    }
    function goDebug(){
      window.location.href = '/';
    }
    function saveConfig(){
      putInConfig();
      var name= prompt("Please enter the name for the new config file:", "config");
      if (name)
        socket.emit('configExists', name);
    }
    function loadConfig(index){
      socket.emit('loadConfig', configList[index]);
    }
    function loadConfigList(){
      socket.emit('getConfigList');
    }
    function closeList(){
      $('#list').remove();
    }
    function loadDefault(){
      if (confirm("Do you really want to return to the default settings?")){
        socket.emit('loadDefault');
      }
    }
    function setSettings(){
      if (confirm("Do you really want to save these settings?")){
        putInConfig()
        
        socket.emit('settings',config);
        setTimeout(function(){ 
          window.location.href = '/';
        }, 5000);
      }
    }
    function deleteConfig(index){
      if (confirm("Do you really want to delete "+configList[index]+"?")){
        socket.emit('deleteConfig', configList[index]);
        socket.emit('getConfigList');
      }
    }
    function downloadConfig(index){
      window.location.href = '/downloadConfig?file='+configList[index];
      console.log('/downloadConfig?file='+configList[index]);
    }
    function uploadConfig(){
      $('#configLocation').click();
    }

    
    socket.on('configList', function(list){
      $('#list').remove();
      $(address(6, 1)).append( $('<div id="list">').append('<ul>'));

      configList=list;

      if (list.length==0){
        $('ul').append($('<li>').append('No configs found'));
      }
      else{
        list.forEach((element, index) => {
          let newItem = $('<li>').append('<span>'+element+'</span>')
            .append('<input type="button" class="config" value="Download" onclick="javascript:downloadConfig('+index+')">')
            .append('<input type="button" class="config" value="Load" onclick="javascript:loadConfig('+index+')">')
            .append('<input type="button" class="config" value="Delete" onclick="javascript:deleteConfig('+index+')">');
          $('ul').append(newItem);
        });
      }
      let lastRow = $('<li>');
      lastRow.append('<input type="button" style="width:50%" value="Close" onclick="javascript:closeList()">');
      lastRow.append('<input type="button" style="width:50%" value="Upload" onclick="javascript:uploadConfig()">');
      lastRow.append($('<form id="uploadForm" action="uploadConfig" method="post" enctype="multipart/form-data">').html('<input id="configLocation" style="display:none" type="file" name="importConfig" accept=".js">').change(function(evt){
        let file = evt.target.files[0];

        let mayorVersion = file.name.match(/V[0-9\.]+\.js$/);
        if (!mayorVersion){
          alert('Config does not have a valid name');
          return;
        }
        mayorVersion = mayorVersion[0].slice(1,-3).split('.')[0];
        let currentMayorVersion = config.version.split('.')[0];
        if(mayorVersion !== currentMayorVersion){
          alert('Version of new config does not match the current one');
          return;
        }

        $('#uploadForm').submit();
      })); 

      $('ul').append(lastRow);
    });

    socket.on('config', function(newConfig){
      eval(newConfig);
      console.log(newConfig);
      fillIn();
    })

    socket.on('configExistsResult', ({result, name}) =>{
      if (!result || confirm("File already exists, do you want to overwrite?")){
        socket.emit('saveConfig', {name: name, config: config});
      }
    });

    fillIn();
  </script>
</body>
</html>