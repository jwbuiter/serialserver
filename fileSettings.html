<!doctype html>
<html>
<head>
  <title>MBDCcomUnit</title>
   <style>
      *{font-size: 25px; padding:0; margin: 0; }
      table { text-align: center; border: none; border-collapse: collapse;}
      tr { height: 29px; }
      td { position: relative; text-align: center;  border-style: bold; height: 29px;}
      td.right { text-align: right; }
      td.small { font-size: 15px; }
      input {text-align: center; width: 100%;}
      input[type="submit"]{width: auto;}
      input[type="time"]{font-size: 19px;}
      input.config {width: 20%; float:right; font-size: 20px;}
      select { width: 100%;}
      #list {width: 50vw;text-align: left; position: absolute; right: 100%; top: 2.5em;z-index: 2; background-color: white; border: 1px solid black; padding: 5px;}
      ul { list-style-type: none;}
      li {margin: 0 0 3px 0;}
    </style>
</head>
<body>
  <div>
    <table id="content">
    </table>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script src="/res/jquery-1.11.1.js"></script>
  <script src="/config.js"></script>
  <script type="text/javascript">
    if (screen.width>1000){
      var columnWidths = [12, 12, 28, 12, 12, 12, 12];
    }
    else{
      var columnWidths = [14, 15, 25, 12, 18, 14, 16];
      $('#content').css('width', columnWidths.reduce(function(acc, val) { return acc + val; }) + 'vw');
    }
    
    var socket = io();
    var configList;

    const numColumns = 7;
    var numRows = 0;
    const tableNumbers = 5;
    const tableLetters = 2;
    const numOutputs = 10;
    const numInputs = 5;

    function address(columnNum, rowNum){
      while (rowNum>=numRows){
        var currentRow = $('<tr>');
        $('#content').append(currentRow);
        for (let i = 0; i < numColumns; i++){
          var newCell = $('<td>').attr('id', 'c' + i + 'r' + numRows);
          newCell.css('max-width', columnWidths[i] + 'vw');
           newCell.css('width', columnWidths[i] + 'vw');
          currentRow.append(newCell);
        }
        numRows++;
      }
      return '#c' + columnNum + 'r' + rowNum;
    }

    $(address(0, 0)).append($('<b>').html('Trigger'));
    $(address(1, 0)).append($('<b>').html('Search Column'));
    $(address(0, 1)).append($('<select id ="triggerCom">').html('<option value="0">COM 0</option><option value="1">COM 1</option>'));
    $(address(1, 1)).append($('<input type="text" id="searchColumn">'));

    $(address(5, 1)).append($('<input type="button" value="Cancel" onclick="javascript:goDebug()">'));
    $(address(5, 0)).append($('<input type="button" value="Save" onclick="javascript:setSettings()">'));
    $(address(6, 0)).append($('<input type="button" value="Save config" onclick="javascript:saveConfig()">'));
    $(address(6, 1)).append($('<input type="button" value="Load config" onclick="javascript:loadConfigList()">'));
    $(address(6, 2)).append($('<input type="button" value="Load default" onclick="javascript:loadDefault()">'));
    $(address(5, 2)).append($('<b>').html('Version: '+config.version));

    $(address(2, 0)).append($('<b>').html('Wait for second COM'));
    $(address(3, 0)).append($('<b>').html('Save to file'));
    $(address(4, 0)).append($('<b>').html('Use file'));
    $(address(2, 2)).append($('<b>').html('File reset: '));
    $(address(2, 2)).addClass('right');
    $(address(2, 1)).append($('<input type="checkbox" id="waitForOther">'));
    $(address(3, 1)).append($('<input type="checkbox" id="saveToFile">'));
    $(address(4, 1)).append($('<input type="checkbox" id="useFile">'));
    $(address(3, 2)).append($('<select id ="resetFile">').html('<option value="off">Off</option><option value="interval">Interval</option><option value="time">Time of day</option>'));
    $(address(4, 2)).append($('<input type="time" id="fileResetValue">'));

    var cursor = 4;

    $(address(0, cursor)).append($('<b>').html('Table'));
    $(address(1, cursor)).append($('<b>').html('Name'));
    $(address(2, cursor)).append($('<b>').html('Formula'));
    $(address(3, cursor)).append($('<b>').html('Numeric'));
    $(address(4, cursor)).append($('<b>').html('Digits/round.'));
    $(address(5, cursor)).append($('<b>').html('Command'));
    $(address(6, cursor)).append($('<b>').html('Value'));
    var commands = [
      'com0',
      'com1',
      'date',
      '$A',
      '#A1',
      '#O1',
      '#I1',
      '#',
      'and',
      'or',
      '( )',
      '==',
      '!=',
      '>',
      '>=',
      '<',
      '<=',
      '+',
      '-',
      '*',
      '/',
    ];
    var meanings = [
      'value com0',
      'value com1',
      'date today',
      'value input-file column A',
      'value table #A1',
      'value output 1 (0 or 1)',
      'value input 1 (0 or 1)',
      'manual input',
      'meets both commands',
      'meets 1 of the commands',
      'priority',
      'equal to',
      'not equal to',
      'greater than',
      'greater or equal to',
      'less than',
      'less or equal to',
      'add',
      'substract',
      'multiply',
      'divide',
    ];
    cursor++;
    for (let i = 0; i < commands.length; i++){
      $(address(5, i + cursor)).html(commands[i]);
      $(address(5, i + cursor)).addClass('small');
      $(address(6, i + cursor)).html(meanings[i]);
      $(address(6, i + cursor)).addClass('small');
    }
    
    for (let i = 0; i < tableLetters; i++){
      for (let j = 0; j < tableNumbers; j++){
        $(address(0, cursor)).append($('<b>').html('#' + String.fromCharCode(65 + i) + (j + 1)));
        $(address(1, cursor)).append($('<input type="text" id="nameTable' + (i*tableNumbers + j) + '">'));
        $(address(2, cursor)).append($('<input class="wide" type="text" id="formulaTable' + (i*tableNumbers + j) + '">'));
        $(address(3, cursor)).append($('<input type="checkbox" id="numericTable' + (i*tableNumbers + j) +'">'));
        $(address(4, cursor)).append($('<input type="number" id="digitsTable' + (i*tableNumbers + j) + '" min="0" step="1">'));
        cursor++;
      }
    }
    cursor ++;

    $(address(1, cursor)).append($('<b>').html('Name'));
    $(address(2, cursor)).append($('<b>').html('Formula'));
    $(address(3, cursor)).append($('<b>').html('Execute'));
    $(address(4, cursor)).append($('<b>').html('Seconds'));
    cursor++;

    for (let i = 0; i < numOutputs; i++){
      $(address(0, cursor)).append($('<b>').html('Output ' + (i + 1)));
      $(address(1, cursor)).append($('<input type="text" id="nameOutput' + i + '">'));
      $(address(2, cursor)).append($('<input class="wide" type="text" id="formulaOutput' + i + '">'));
      $(address(3, cursor)).append($('<input type="checkbox" id="executeOutput' + i + '">'));
      $(address(4, cursor)).append($('<input type="number" id="secondsOutput' + i + '" min="0" step="1">'));
      cursor++;
    }
    cursor++;

    $(address(1, cursor)).append($('<b>').html('Name'));
    $(address(2, cursor)).append($('<b>').html('Command'));
    $(address(3, cursor)).append($('<b>').html('Invert'));
    $(address(4, cursor)).append($('<b>').html('Follow'));
    $(address(5, cursor)).append($('<b>').html('Timeout'));
    cursor++;

    for (let i = 0; i < numInputs; i++){
      $(address(0, cursor)).append($('<b>').html('Input ' + (i + 1)));
      $(address(1, cursor)).append($('<input type="text" id="nameInput' + i + '">'));

      let commandSelect = $('<select selected=" " class="wide" id="formulaInput' + i + '">');
      commandSelect.append('<option value=""></option><option value="exe">Execute</option><option value="exebl">Execute block</option>');
      $(address(2, cursor)).append(commandSelect);
      $(address(3, cursor)).append($('<input type="checkbox" id="invertInput' + i + '">'));

      let followSelect = $('<select selected="-1" id="followInput' + i + '">');
      followSelect.append('<option value="-1">None</option>');
      for (let j = 0; j < numOutputs; j++){
        followSelect.append('<option value="'+j+'"">Output '+(j+1)+'</option>');
      }
      $(address(4, cursor)).append(followSelect);
      $(address(5, cursor)).append($('<input type="number" id="timeoutInput' + i + '" min="0" step="1">'));
      
      cursor++;
      address(3, cursor);
    }
    function fillIn(){
      for (var i = 0; i < 10; i++)
      {
        var conf = config.table[i];
        Object.keys(conf).forEach(function(key) 
        {
          let target = $(`#${key}Table${i}`);
          if (typeof(conf[key]) === "boolean")
          {
            target.prop('checked', conf[key]);
          }
          else
          {
           target.val(conf[key]);
          }
        });
      }
      for (var i = 0; i < 10; i++)
      {
        var conf = config.output[i];
        Object.keys(conf).forEach(function(key) 
        {
          let target = $(`#${key}Output${i}`);
          if (typeof(conf[key]) === "boolean")
          {
            target.prop('checked', conf[key]);
          }
          else
          {
           target.val(conf[key]);
          }
        });
      }
      for (var i = 0; i < 5; i++)
      {
        var conf = config.input[i];
        Object.keys(conf).forEach(function(key) 
        {
          let target = $(`#${key}Input${i}`);
          if (typeof(conf[key]) === "boolean")
          {
            target.prop('checked', conf[key]);
          }
          else
          {
           target.val(conf[key]);
          }
        });
      }
      $('#triggerCom').val(config.triggerCom);
      $('#searchColumn').val(config.searchColumn);
      $('#waitForOther').prop('checked', config.waitForOther);
      $('#saveToFile').prop('checked', config.saveToFile);
      $('#useFile').prop('checked', config.useFile);
      $('#resetFile').val(config.resetFile);
      $('#fileResetValue').val(config.fileResetValue);
    }

    function putInConfig(){
      for (var i = 0; i < 10; i++)
      {
        var conf = config.table[i];
        Object.keys(conf).forEach(function(key) 
        {
          let element = $(`#${key}Table${i}`);
          if (element.length!=0)
          {
            if (typeof(conf[key]) === "boolean")
            {
              conf[key] = element.prop('checked');
            }
            else if (typeof(conf[key]) === 'number')
            {
              conf[key] = Number(element.val());
            }
            else
            {
              conf[key] = element.val();
            }
          }
        });
        var conf = config.output[i];
        Object.keys(conf).forEach(function(key) 
        {
          let element = $(`#${key}Output${i}`);
          if (element.length!=0)
          {
            if (typeof(conf[key]) === "boolean")
            {
              conf[key] = element.prop('checked');
            }
            else if (typeof(conf[key]) === 'number')
            {
              conf[key] = Number(element.val());
            }
            else
            {
              conf[key] = element.val();
            }
          }
        });
      }
      for (var i = 0; i < 5; i++)
      {
        var conf = config.input[i];
        Object.keys(conf).forEach(function(key) 
        {
          let element = $(`#${key}Input${i}`);
          if (element.length!=0)
          {
            if (typeof(conf[key]) === "boolean")
            {
              conf[key] = element.prop('checked');
            }
            else if (typeof(conf[key]) === 'number')
            {
              conf[key] = Number(element.val());
            }
            else
            {
              conf[key] = element.val();
            }
          }
        });
      }
      config.triggerCom = Number($('#triggerCom').val());
      config.searchColumn = Number($('#searchColumn').val());
      config.waitForOther = $('#waitForOther').prop('checked');
      config.saveToFile = $('#saveToFile').prop('checked');
      config.useFile = $('#useFile').prop('checked');
      config.resetFile = $('#resetFile').val();
      config.fileResetValue = $('#fileResetValue').val();
    } 


    function setDate(){
      let dateTimeString = $('#date').val() + ' ' + $('#time').val()
      let dateTime = Date.parse(dateTimeString);
      socket.emit('setDateTime', dateTime/1000);
    }
    function goSubmit(){
      $('#uploadForm').submit();
    }
    function goDebug(){
      window.location.href = '/';
    }
    function saveConfig(){
      putInConfig();
      var name= prompt("Please enter the name for the new config file:", "config");
      if (name)
        socket.emit('save', {name: name, config: config});
    }
    function loadConfig(index){
      socket.emit('load', configList[index]);
    }
    function loadConfigList(){
      socket.emit('getConfigList');
    }
    function closeList(){
      $('#list').remove();
    }
    function loadDefault(){
      if (confirm("Do you really want to return to the default settings?")){
        socket.emit('loadDefault');
      }
    }
    function setSettings(){
      if (confirm("Do you really want to save these settings?")){
        putInConfig()
        
        socket.emit('settings',config);
        setTimeout(function(){ 
          window.location.href = '/';
        }, 5000);
      }
    }
    function deleteConfig(index){
      if (confirm("Do you really want to delete "+configList[index]+"?")){
        socket.emit('deleteConfig', configList[index]);
        socket.emit('getConfigList');
      }
    }

    socket.on('configList', function(list){
      $('#list').remove();
      $(address(6, 1)).append( $('<div id="list">').append('<ul>'));

      configList=list;

      if (list.length==0){
        $('ul').append($('<li>').append('No configs found'));
      }
      else{
        list.forEach((element, index) => {
          let newItem = $('<li>').append('<span>'+element+'</span>')
            .append('<input type="button" class="config" value="Load" onclick="javascript:loadConfig('+index+')">')
            .append('<input type="button" class="config" value="Delete" onclick="javascript:deleteConfig('+index+')">');
          $('ul').append(newItem);
        });
      }
      $('ul').append($('<li>').append('<input type="button" value="Close" onclick="javascript:closeList()">'));
    });

    socket.on('config', function(newConfig){
      eval(newConfig);
      console.log(newConfig);
      fillIn();
    })

    fillIn();
  </script>
</body>
</html>